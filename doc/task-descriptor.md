# Task descriptor

The task descriptor is a Python list that contains at least one element
defining a [task implementation] (there might be more than one, if the source
implements more than one PII Detector Tasks).

There are several places in which task descriptors can be used:
 * As a JSON list, to feed to a `JsonTaskCollector` object
 * As a module variable, which will be collected by a `FolderTaskCollector`
   object. The name of the variable **must be** `PII_TASKS`
 * The `get_plugin_tasks()` method in pii-extract plugins must return an
   iterable of task descriptors, which is then picked up by the
   `PluginTaskCollector` module

A task descriptor in a list can have two different shapes: simplified and
full (a single list can contain items of both shapes)


## Simplified descriptor

In a simplified description a task must be a 2- or 3-element tuple, with
these fields:
 - the PII type the task can generate: a member of [PiiEnum]
 - the [task implementation]: the regex, function or class implementing the PII
   detector
 - a string, containing an optional `subtype` for the task


## Full descriptor

In a full description a task is a dictionary with at least these compulsory
fields:

 * `class`: a string indicating the implementation class for the task. It can
    be `regex`, `regex-external`, `callable` or `PiiTask`
 * `task`: a pointer to the task implementation:
      - for `regex` tasks, a raw string (containing the regex to be used)
	  - a `regex-external` task contains a string with a _reference_ to the
	    regex to be imported
      - for `function` tasks a callable (or a string with the full import
		path for the callable)
	  - for `PiiTask` either a Python class object or a string with a full
	    class name (including the corresponding Python package)
 * `pii`: a dictionary describing the PII Entity that this task generates;
    see [below](#pii-entity)

This dictionary can also have these optional fields:

 * `source`: a string indicating the source (organization, project, etc) of
   the task implementation
 * `name`: a name for the task
 * `version`: a version number for the task, as a string
 * `method`: a string describing the method implemented by this task, as a
   comma-separated list of keywords. Possible keywords are, e.g. `regex`,
   `weak-regex`, `model`, `context`, `checksum`, etc.
 * `doc`: a text documentation for the class.
 * `doctype`: the source document subclasses to which it can be applied, as
   a list of strings (`sequence`, `tree`, `table`). If not present,
   it is assumed it applies to all *[currently unused]*
 * `kwargs`: a dictionary of additional arguments. For `PiiTask` task types,
   they will be added as arguments to the class constructor; for `callable`
   types they will be added when calling the task function. It is ignored
   for `regex` types.

Some of these fields, when not present in the descriptor dictionary, can take
their values from elsewhere:
 * For `PiiTask` types, the `source`, `name`, `version`, `method` and
   `doc` fields can also be provided as class-level attributes: `pii_source`,
   `pii_name`, `pii_version`, `pii_method` and `pii_doc`
 * `regex` tasks will automatically fill their `method` field with a default
   value if still not defined
 * If still no `name` attribute is available,
    - for `PiiTask` and `callable` tasks, it can be generated automatically
	  from the class/callable Python name
    - else, a generic name will be created using the task type + the PII types
	  (and subtypes) it detects
 * Finally, the `doc` field has two additional sources:
    - `callable` and `PiiTask` types can use the function/class docstring
    - else, a synthetic text using the other fields will be constructed


### PII Entity

The `pii` field in the full task descriptor defines the [PII Entities] that will
be detected by the task. Its main form is as a dictionary with the folllowing
fields:
 * `type`: the PII Entity identifier for the task. It can be
   a member of [PiiEnum] or its equivalent string value. This is the only
   compulsory field in the dictionary
 * `subtype`: the subtype of the entities generated by this task. It can also
   be a list of subtypes.
 * `lang`: language this task is designed for (it can also be `LANG_ANY`).
 * `country`: country this task is designed for.
 * `context`: see [context validation] below.
 * `method`: method used by the task to detect this entity, if different
   from the one declared at the task level (this is intended for
   [multitasks](#multitasks))
 * `extra`: a dictionary of arbitrary additional data that will be passed
   along to the task implementation as extra information. It is analogous to
   the `kwargs` argument in the base task descriptor, but in the case of
   [multitasks](#multitasks) it allows to indicate a different information
   for each PII.


Some of these fields can be collected from elsewhere, if not defined in the
dictionary:

 * `lang` and `country`, when using a `FolderTaskCollector`, can be
   determined from the folder structure the task implementation is in. If no
   values can be obtained, `LANG_ANY` and `COUNTRY_ANY` are assumed
 * `subtype`, when using class-based implementations, can be gathered from
   the `pii_subtype` attribute of the class


### Special forms

The `pii` field can contain two alternate shapes to the standard dictionary:

#### multitasks

A multitask `pii` field contains a _list of dictionaries_. In this case it is
understood that the task is a  _multitask_ that can generate PII instances of
several types. Each element in the list is a standard `pii` dictionary.

#### flattened descriptors

For backwards compatibility, the `pii` field can contain a single `PiiEnum`
value (or string), which will be taken as the `type` element in the `pii`
dictionary. All the remaining fields (`lang`, `country`, etc) are expected
to be contained in the base task dictionary.


## Context validation

A task of any of the three types of [task implementation] may also include an
additional step for context validation. In this step, all detected PII are
further validated by ensuring that a document chunk around the detected PII
string (before and after) contains one of the specified text contexts.

Context validation can have three variants:
 * `string`: each text context is a substring to be fully matched.
 * `word`: each text context is also a substring to be matched, but matching
   is ensured to work only on full words (the substring can contain more than
   one word, but it will be matched only to sequences of full words). Here a
   "word" in defined by the Python regular expression token `\b` as word
   separator.
 * `regex`: each context is a regular expression (to be matched by the [regex]
   Python package, and compiled with the `re.VERSBOSE`flag)

Regardless of the variant, matching is always performed after normalizing
the extracted document context chunk: normalize whitespace (replace all
whitespace sequences in the chunk by a single space) and lowercase the chunk.

This validation acts as a filter after the task implementation produces its
results, and it is automatically applied if the task descriptor includes
context (for class-based tasks, it can be replaced with custom code by
overriding the `find_context()` method, defined in the parent class).

Context is defined by a `context` field present in the `pii` dictionary
of the task descriptor (note that task descriptors with context *must* be a
full description, i.e. the dict version).

This field is a dictionary, with the following elements:
 * `type` indicates the variant: `string`, `word`, `regex`. If not present,
   `string` is assumed.
 * `value` should be a list of strings, any of which validate a document
   context. For `regex` mode the strings will be regex patterns.
 * `width` is an integer, or a tuple of two integers, that define
   the width (in characters) of the document chunk (before and after the PII
   string) that define the document context. If not specified, a default is
   used.

As a shortcut, the `context` field can also contain a simple list of strings
(or even a single string). In this case, the context is defined as type
`string`, with the default width, and the field contents define the value(s).

An example of context validation can be seen in the [international phone
number] task.


[context validation]: #context-validation
[task implementation]: task-implementation.md
[PiiEnum]: https://github.com/piisa/pii-data/blob/main/src/pii_data/types/piienum.py
[PII Entities]: https://github.com/piisa/pii-data/blob/main/doc/piientity.md
[test/unit/lang]: ../test/unit/lang
[international phone number]: ../test/taux/modules/en/any/international_phone_number.py

[ISO 639-1]: https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes
[ISO 3166-1]: https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2
[regex]: https://github.com/mrabarnett/mrab-regex
